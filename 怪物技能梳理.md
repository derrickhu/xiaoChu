# 怪物技能梳理文档

## 一、怪物技能总览（10种）

| 技能键名 | 技能名称 | 类型 | 效果描述 | 关键参数 |
|---------|---------|------|---------|---------|
| atkBuff | 妖气暴涨 | buff | 攻击提升30%,持续2回合 | field:'atk', rate:0.3, dur:2 |
| poison | 瘴毒 | dot | 每回合造成{val}点伤害,持续3回合 | dur:3（伤害=atk×0.3） |
| seal | 禁珠咒 | seal | 随机封锁2颗灵珠,持续2回合 | count:2, dur:2 |
| convert | 灵脉紊乱 | convert | 随机转换3颗灵珠属性 | count:3 |
| aoe | 妖力横扫 | aoe | 对修士造成额外伤害 | 伤害=atk×0.5 |
| defDown | 碎甲爪 | debuff | 降低修士防御30%,持续2回合 | field:'def', rate:0.3, dur:2 |
| healBlock | 噬灵术 | debuff | 心珠回复量减半,持续3回合 | field:'healRate', rate:0.5, dur:3 |
| stun | 妖力震慑 | stun | 眩晕修士，无法操作1回合 | dur:1 |
| selfHeal | 妖力再生 | selfHeal | 回复自身15%最大血量 | pct:15 |
| breakBead | 碎珠术 | breakBead | 随机破坏3颗灵珠 | count:3 |

---

## 二、怪物分类与技能分配

### 普通怪物（30层制，HP约翻倍以保证3-4回合战斗节奏）
| 层段 | HP | ATK | DEF(ATK×0.35) | 技能数 | 技能池 |
|------|-----|-----|------|--------|-------|
| 1~5层 | 120~240 | 3~6 | 1~2 | 0 | 无技能 |
| 6~10层 | 260~480 | 6~12 | 2~4 | 0 | 无技能 |
| 9~10层 | (同上) | (同上) | (同上) | 1 | poison/seal/convert |
| 11~15层 | 500~850 | 11~20 | 4~7 | 1 | poison/seal/convert |
| 16~17层 | 880~1060 | 18~26 | 6~9 | 1 | poison/seal/convert |
| 18~20层 | 1060~1350 | 26~32 | 9~11 | 2 | +atkBuff/defDown/healBlock |
| 21~25层 | 1400~2200 | 30~50 | 11~18 | 2 | +atkBuff/defDown/healBlock |
| 26~30层 | 2300~3600 | 45~75 | 16~26 | 2 | +atkBuff/defDown/healBlock |

> ⚠️ 25层以上有30%概率带第3个技能（含breakBead）

### 精英怪物
- 数值：普通×(2.2~2.8)血 ×(1.6~2.0)攻 ×1.5防
- 技能：2个不重复，从 `stun/defDown/selfHeal/breakBead/atkBuff/poison/seal` 中随机

### BOSS（每10层）
- 数值：递增倍率（HP 2.5~5×, ATK 1.5~2.5×, DEF 1.2~2×）
- 技能：2个（1控制 + 1防御/增强）
  - 控制技能池：stun/seal/convert
  - 防御技能池：selfHeal/atkBuff/defDown/healBlock

---

## 三、技能触发机制

- **触发条件**：每3回合触发1次（turnCount % 3 === 0 且 turnCount > 0）
- **选取方式**：从怪物技能列表中随机选取1个释放
- **触发顺序**：在敌方回合中，先执行普通攻击 → 玩家DOT结算 → 技能释放 → 怪物DOT结算 → 怪物自愈

---

## 四、各技能检查状态

### ✅ 已生效的技能（6个）

| 技能 | 实现位置 | 说明 |
|------|---------|------|
| atkBuff | applyEnemySkill → enemyBuffs, enemyTurn L586-587 | ✅ 正确：添加buff，攻击时检查field==='atk'并乘以(1+rate) |
| poison(dot) | applyEnemySkill → heroBuffs, enemyTurn L628-634 | ✅ 正确：添加dot到heroBuffs，每回合对玩家造成atk×0.3伤害 |
| convert | applyEnemySkill L675-680 | ✅ 正确：随机3格改为五行随机属性 |
| aoe | applyEnemySkill L682 | ✅ 正确：直接造成atk×0.5伤害 |
| selfHeal | applyEnemySkill L692-693, enemyTurn L647-651 | ✅ 正确：立即回复15%血量（applyEnemySkill中立即回复 + enemyTurn中enemyBuffs也检查） |
| breakBead | applyEnemySkill L694-700 | ✅ 正确：随机3格设null，调用fillBoard填充 |

### ❌ 未生效的技能（4个）→ 已全部修复 ✅

#### 1. `stun`（heroStun）— 眩晕修士 ✅ 已修复
- **描述**：眩晕修士，无法操作1回合
- **原问题**：`applyEnemySkill` 正确添加 `{type:'heroStun', dur:1}` 到 `heroBuffs`，但 main.js 中的 playerTurn 状态完全不检查 heroStun。进入 playerTurn 后玩家仍然可以正常拖拽和释放技能
- **修复**：在 main.js 中 enemyTurn→playerTurn 切换时检查 heroStun，若有则消耗并跳过玩家操作

#### 2. `defDown`（debuff field:'def'）— 碎甲爪 ✅ 已修复
- **描述**：降低修士防御30%,持续2回合
- **原问题**：`applyEnemySkill` 添加 debuff 到 heroBuffs，但 enemyTurn 的减伤计算中完全不检查 defDown debuff
- **修复**：在 enemyTurn 减伤计算中检查 debuff.field==='def'，作为负向减伤（增伤效果）

#### 3. `healBlock`（debuff field:'healRate'）— 噬灵术 ✅ 已修复
- **描述**：心珠回复量减半,持续3回合
- **原问题**：`applyEnemySkill` 添加 debuff 到 heroBuffs，但心珠回复计算从未检查 healRate debuff
- **修复**：在心珠回复计算中检查 debuff.field==='healRate'，将回复量乘以 rate（减半）

#### 4. `seal`（禁珠咒）— 封锁机制不完整 ✅ 已修复
- **描述**：随机封锁2颗灵珠,持续2回合
- **原问题a**：sealed 没有持续时间管理，永久封锁直到珠子被消除
- **原问题b**：sealed 珠子仍然可以被正常拖拽和交换
- **修复a**：sealed 改为数字（剩余回合数），在 settle 中每回合递减自动解封
- **修复b**：在拖拽逻辑中禁止拾起和交换到 sealed 位置

---

## 五、怪物名称池

### 普通怪物（按属性×层段，每5层升一档）
| 属性 | 1~4层 | 5~9层 | 10~14层 | 15~19层 | 20~24层 | 25~29层 | 30层 |
|------|--------|---------|---------|---------|---------|---------|------|
| 金 | 金灵鼠妖 | 铜甲兵 | 金锋散修 | 锐金妖兵 | 金翎蛮将 | 天罡妖卫 | 金鹏妖尊 |
| 木 | 木灵花妖 | 藤蔓小精 | 青木散修 | 枯藤妖兵 | 苍木蛮将 | 灵木妖卫 | 万木妖尊 |
| 土 | 土灵石怪 | 泥人兵 | 黄土散修 | 山岩妖兵 | 裂地蛮将 | 厚土妖卫 | 磐岩妖尊 |
| 水 | 水灵鱼妖 | 冰魄小精 | 碧水散修 | 寒潮妖兵 | 沧澜蛮将 | 深渊妖卫 | 蛟龙妖尊 |
| 火 | 火灵狐妖 | 焰灵小精 | 赤炎散修 | 爆炎妖兵 | 焚天蛮将 | 烈焰妖卫 | 朱雀妖尊 |

### 精英怪物（按属性，每属性3个）
| 属性 | 名称1 | 名称2 | 名称3 |
|------|-------|-------|-------|
| 金 | 金甲妖将·碎天 | 破军金狮 | 金罡战魔 |
| 木 | 枯木大妖·噬灵 | 缠枝毒蛇王 | 万木妖魔 |
| 土 | 磐岩巨魔·震地 | 山岳石王 | 镇地魔将 |
| 水 | 深渊蛟魔·溺魂 | 冰魄仙蛇 | 寒潮魔将 |
| 火 | 焚天魔凰·灭世 | 炎狱妖帝 | 赤炎魔君 |

### BOSS（每10层，30层制共3个BOSS层）
| 层数 | 名称 | HP倍率 | ATK倍率 | DEF倍率 | 技能数 |
|------|------|--------|---------|---------|--------|
| 10 | BOSS_NAMES随机 | 2.5× | 1.5× | 1.2× | 2（控制+防御） |
| 20 | 五行妖将·破阵（固定） | 3.3× | 1.8× | 1.4× | 3（+额外技能） |
| 30 | 天罡妖帝·噬天（固定） | 4.1× | 2.1× | 1.6× | 3（+额外技能） |

> BOSS基础数值 = 该层普通怪基础数值 × 倍率。30层BOSS举例：普通怪HP≈3600，×4.1≈14760

---

## 六、修复总结

### 已修复（共4个问题）：

#### 1. heroStun 未阻止玩家操作 ✅ 已修复
- **影响**：所有带stun技能的精英/BOSS
- **修复方式**：在 `main.js` 中 enemyTurn 结束切回 playerTurn 时检查 heroStun，若有则消耗该buff并跳过操作回合（显示"被眩晕！跳过操作"飘字），直接进入下一个 preEnemy 阶段

#### 2. defDown debuff 未生效 ✅ 已修复
- **影响**：所有带defDown技能的怪物（普通45+层、精英、BOSS）
- **修复方式**：在 `battle.js` `enemyTurn` 的减伤计算中新增检查 `debuff.field==='def'`，将 rate×100 作为负向减伤百分比（即 defDown rate:0.3 → 减伤-30%，等效增伤30%）

#### 3. healBlock debuff 未生效 ✅ 已修复
- **影响**：所有带healBlock技能的怪物（普通45+层、BOSS）
- **修复方式**：在 `battle.js` 心珠回复计算（startNextElimAnim）中新增检查 `debuff.field==='healRate'`，将回复量乘以 rate（healBlock rate:0.5 → 回复减半）

#### 4. seal 封锁机制不完整 ✅ 已修复（2个子问题）
- **影响**：所有带seal技能的怪物（普通21+层、精英、BOSS）
- **问题4a：无持续时间管理**
  - 修复：seal 设置 `sealed` 为数字（剩余回合数）而非布尔值，在 `settle` 函数中每回合递减，归0自动解封
- **问题4b：封锁的珠子仍可拖拽交换**
  - 修复：在 `touchHandlers.js` 拖拽逻辑中，禁止拾起 sealed 珠子，禁止将珠子交换到 sealed 位置
