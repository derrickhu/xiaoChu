# 法宝技能梳理

> 生成时间：2026-02-19
> 基于 `js/data/weapons.js`（50件法宝）和 `js/engine/battle.js`、`js/main.js`、`js/engine/runManager.js` 的代码分析

## 一、法宝系统设计说明

- 共50件法宝，**不分属性**
- 主角仅装备**1件**，全程被动生效
- 法宝 = 被动技能（类似队长技能）
- 法宝本身无属性、无攻击值
- 某些法宝效果针对特定属性（用 `attr` 字段表示）
- 法宝效果不需要主动释放，**进入战斗后自动生效**

## 二、法宝技能类型总览

### 攻击增伤类（7件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w1 | 天机镜 | 全队攻击力+15% | allAtkUp | pct:15 | applyFinalDamage/enterPetAtkShow | ✅ |
| w2 | 破军钟 | 金属性伤害+35% | attrDmgUp | attr:metal, pct:35 | applyFinalDamage/enterPetAtkShow | ✅ |
| w3 | 碧落仙葫 | 木属性伤害+35% | attrDmgUp | attr:wood, pct:35 | applyFinalDamage/enterPetAtkShow | ✅ |
| w4 | 沧海玄珠 | 水属性伤害+35% | attrDmgUp | attr:water, pct:35 | applyFinalDamage/enterPetAtkShow | ✅ |
| w5 | 赤霄神灯 | 火属性伤害+40% | attrDmgUp | attr:fire, pct:40 | applyFinalDamage/enterPetAtkShow | ✅ |
| w6 | 昆仑玉璧 | 土属性伤害+35% | attrDmgUp | attr:earth, pct:35 | applyFinalDamage/enterPetAtkShow | ✅ |
| w7 | 八卦金盘 | Combo伤害额外+25% | comboDmgUp | pct:25 | applyFinalDamage | ✅ |

### 暴击类（4件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w10 | 火凤令牌 | 暴击率+25%，暴击伤害+40% | critAll | critRate:25, critDmg:40 | calcCrit | ✅ |
| w11 | 紫金葫芦 | 消除5个金珠必定暴击 | guaranteeCrit | attr:metal, minCount:5 | calcCrit | ✅ |
| w12 | 焚心宝印 | 每段Combo暴击率+5% | comboToCrit | pct:5 | calcCrit | ✅ |
| w36 | 定水神针 | 消除5个水珠必定暴击 | guaranteeCrit | attr:water, minCount:5 | calcCrit | ✅ |

### 防御减伤类（3件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w14 | 藤甲天衣 | 受到土属性怪普攻伤害-30% | reduceAttrAtkDmg | attr:earth, pct:30 | enemyTurn | ✅ |
| w16 | 厚土宝甲 | 受到所有伤害-15% | reduceDmg | pct:15 | enemyTurn | ✅ |
| w17 | 烈焰神甲 | 受到金属性怪普攻伤害-30% | reduceAttrAtkDmg | attr:metal, pct:30 | enemyTurn | ✅ |

### 技能减伤类（1件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w15 | 寒冰宝鉴 | 受到敌方直接技能伤害-25% | reduceSkillDmg | pct:25 | applyEnemySkill | ✅ |

### 属性宠物攻击强化类（2件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w9 | 燎原宝塔 | 火属性宠物攻击力+30% | attrPetAtkUp | attr:fire, pct:30 | applyFinalDamage/enterPetAtkShow | ✅ |
| w13 | 玄铁如意 | 金属性宠物攻击力+30% | attrPetAtkUp | attr:metal, pct:30 | applyFinalDamage/enterPetAtkShow | ✅ |

### 回血治疗类（6件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w18 | 万寿青莲 | 每回合自动回血5% | regenPct | pct:5 | applyFinalDamage | ✅ |
| w19 | 九转金丹 | 消除金珠时回复5%血量 | healOnElim | attr:metal, pct:5 | startNextElimAnim | ✅ |
| w20 | 缠枝灵索 | 消除木珠时回血5% | healOnElim | attr:wood, pct:5 | startNextElimAnim | ✅ |
| w21 | 凤血丹炉 | 击杀怪物后回血10% | onKillHeal | pct:10 | applyFinalDamage | ✅ |
| w22 | 长生玉牌 | Combo时额外回血2% | comboHeal | pct:2 | applyFinalDamage | ✅ |
| w23 | 玲珑玉净瓶 | 心珠效果+50% | heartBoost | pct:50 | startNextElimAnim | ✅ |

### 血量护盾类（5件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w24 | 建木神符 | 血量上限+25% | hpMaxUp | pct:25 | enterBattle | ✅ |
| w26 | 水月宝镜 | 消除水珠时获得小额护盾 | shieldOnElim | attr:water, val:15 | startNextElimAnim | ✅ |
| w27 | 开山神斧 | 消除土珠时获得护盾 | shieldOnElim | attr:earth, val:20 | startNextElimAnim | ✅ |
| w28 | 山河社稷图 | 护盾效果+50% | shieldBoost | pct:50 | _addShield | ✅ |
| w29 | 不灭金身 | 抵挡1次致死伤害（一局一次） | revive | — | onDefeat | ✅ |

### 无视防御类（1件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w25 | 磐石仙鼎 | 土属性伤害无视怪物防御 | ignoreDefPct | attr:earth, pct:100 | applyFinalDamage | ✅ |

### 珠率提升类（5件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w30 | 聚灵金铃 | 金珠出现概率大幅提升 | beadRateUp | attr:metal | getBeadWeights | ✅ |
| w31 | 扶桑神木 | 木珠出现概率大幅提升 | beadRateUp | attr:wood | getBeadWeights | ✅ |
| w32 | 潮汐法螺 | 水珠出现概率大幅提升 | beadRateUp | attr:water | getBeadWeights | ✅ |
| w33 | 三昧真火扇 | 火珠出现概率大幅提升 | beadRateUp | attr:fire | getBeadWeights | ✅ |
| w34 | 息壤神珠 | 土珠出现概率大幅提升 | beadRateUp | attr:earth | getBeadWeights | ✅ |

### 转珠操控类（1件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w37 | 踏火风火轮 | 转珠时间+2秒 | extraTime | sec:2 | enterBattle | ✅ |

### 斩杀类（1件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w35 | 金翼飞轮 | 敌人残血10%以下时直接斩杀 | execute | threshold:10 | applyFinalDamage | ✅ |

### 特殊触发类（6件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w38 | 炎龙法珠 | 消除5火珠触发额外攻击 | aoeOnElim | attr:fire, minCount:5 | startNextElimAnim | ✅ |
| w39 | 蛊雕毒珠 | 攻击时有概率让怪物中毒 | poisonChance | dmg:15, dur:3, chance:30 | applyFinalDamage | ✅ |
| w40 | 玄龟宝印 | 被攻击反弹20%伤害 | reflectPct | pct:20 | enemyTurn | ✅ |
| w41 | 玄武宝令 | 被攻击有概率眩晕怪物 | counterStun | chance:20 | enemyTurn | ✅ |
| w42 | 碧波神灯 | 怪物眩晕时，我方伤害+40% | stunBonusDmg | pct:40 | applyFinalDamage | ✅ |
| w43 | 浴火金莲 | 残血时临时提升20%伤害 | lowHpDmgUp | pct:20, threshold:30 | applyFinalDamage | ✅ |

### 免疫类（3件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w44 | 鲛人泪珠 | 永久免疫眩晕 | immuneStun | — | applyEnemySkill | ✅ |
| w45 | 灵木仙屏 | 免疫持续伤害 | immuneDot | — | enemyTurn dot处理 | ✅ |
| w47 | 混元宝伞 | 不会被负面效果影响 | immuneDebuff | — | applyEnemySkill | ✅ |

### 破防类（1件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w46 | 镇妖宝塔 | 破防：怪物防御值变为0 | breakDef | — | enterBattle | ✅ |

### 削弱敌方类（1件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w8 | 流云仙扇 | 降低敌方攻击力15% | weakenEnemy | pct:15 | enterBattle | ✅ |

### 层数成长类（3件）

| ID | 名称 | 描述 | type | 参数 | 生效位置 | 状态 |
|----|------|------|------|------|---------|------|
| w48 | 镇岳金印 | 每5层，全队攻击+5% | perFloorBuff | per:5, pct:5, field:atk | nextFloor | ✅ |
| w49 | 九鼎神印 | 每5层血量上限+5% | perFloorBuff | per:5, pct:5, field:hpMax | nextFloor | ✅ |
| w50 | 玄冰琉璃 | 每回合概率挡一次伤害 | blockChance | chance:20 | enemyTurn | ✅ |

---

## 三、技能生效机制分析

法宝作为被动技能，在不同环节自动生效：

| 生效时机 | 技能类型 | 说明 |
|---------|----------|------|
| **棋盘初始化/填充** | beadRateUp | 通过 getBeadWeights 永久提升指定属性珠权重 |
| **进入战斗** | hpMaxUp, extraTime, breakDef, weakenEnemy | 在 enterBattle 中一次性应用 |
| **每层进入** | perFloorBuff | 在 nextFloor 中按层数叠加 |
| **消除珠子时** | healOnElim, shieldOnElim | 在 startNextElimAnim 中检查 |
| **心珠回复** | heartBoost | 在 startNextElimAnim 心珠回复计算中乘以加成 |
| **攻击结算** | allAtkUp, attrDmgUp, attrPetAtkUp, comboDmgUp, ignoreDefPct, lowHpDmgUp, stunBonusDmg, poisonChance, execute | 在 applyFinalDamage 中逐项检查 |
| **暴击判定** | critAll, guaranteeCrit, comboToCrit | 在 calcCrit 中检查 |
| **回复结算** | regenPct, comboHeal, onKillHeal | 在 applyFinalDamage 中检查 |
| **敌方回合** | reduceDmg, reduceAttrAtkDmg, blockChance, reflectPct, counterStun, immuneDot | 在 enemyTurn 中检查 |
| **敌方技能释放** | immuneStun, immuneDebuff, reduceSkillDmg | 在 applyEnemySkill 中检查 |
| **致死判定** | revive | 在 onDefeat 中检查 |
| **护盾获取** | shieldBoost | 在 _addShield 中检查 |

---

## 四、问题汇总

### ✅ 全部技能已生效（50个）
所有法宝技能均已正确实现。

---

## 五、修复记录

### 已修复（17个）

#### 1. `aoeOnElim`（w38 炎龙法珠）— 消除5火珠触发额外攻击 ✅ 已修复
- **问题**：`aoeOnElim` 类型在整个代码中从未被检查
- **修复**：在 `battle.js` `startNextElimAnim` 的消除效果检查区域，新增 aoeOnElim 检查。当消除的珠子属性匹配且数量 >= minCount 时，对敌人造成 maxHp 10% 的额外伤害，显示飘字和震屏，并检查是否击杀
- **描述更新**：改为"消除5火珠触发额外攻击"

#### 2. `immuneDebuff`（w47 混元宝伞）— 不会被负面效果影响 ✅ 已修复
- **问题**：`immuneDebuff` 类型在整个代码中从未被检查
- **修复**：在 `battle.js` `applyEnemySkill` 开头新增 immuneDebuff 检查。定义负面效果类型列表 `['dot','debuff','stun','seal']`，当怪物释放这些类型的技能时，若装备了 immuneDebuff 法宝则直接拦截并显示"免疫！"飘字

#### 3. `immuneStun`（w44 鲛人泪珠）— 永久免疫眩晕 ✅ 已确认
- **问题**：描述说"免疫眩晕1次"但实际代码是永久免疫
- **修复**：描述改为"永久免疫眩晕"，与实际代码行为一致

#### 4. `comboPlus`→`extraTime`（w37 踏火风火轮）— 转珠时间+2秒 ✅ 已重设计
- **问题**：原技能"转珠更易形成大Combo"(`comboPlus`)在法宝层面从未被实现，设计意图不明确
- **修复**：重新设计为 `extraTime` 类型，效果为"转珠时间+2秒"

#### 5. `extraTime`→`execute`（w35 金翼飞轮）— 敌人残血10%以下时直接斩杀 ✅ 已重设计
- **问题**：原技能"转珠时间+1秒"与 w37 重复，无区分度
- **修复**：重新设计为 `execute` 类型，在 `applyFinalDamage` 中伤害结算后，若敌人血量比 ≤ 10%，直接清零并显示"斩杀！"飘字+震屏

#### 6. `extraTime`→`guaranteeCrit`（w36 定水神针）— 消除5个水珠必定暴击 ✅ 已重设计
- **问题**：原技能"转珠时间+1秒"与 w37 重复，无区分度
- **修复**：重新设计为 `guaranteeCrit` 类型，与 w11 紫金葫芦同类型但对应水属性

#### 7. `guaranteeCrit` minCount 检查修复（w11/w36）✅ 已修复
- **问题**：`calcCrit` 中 `guaranteeCrit` 法宝的 `minCount` 参数从未被检查，消除任意数量即触发必暴击
- **修复**：新增 `_pendingAttrMaxCount` 机制，消除时记录每属性最大单次消除数，`calcCrit` 判定时检查 `minCount`，只有消除数 ≥ 5 才触发必暴击

#### 8. `reduceDmg`→`attrPetAtkUp`（w13 玄铁如意）— 金属性宠物攻击力+30% ✅ 已重设计
- **问题**：原技能"受到所有伤害-20%"调整为攻击类
- **修复**：重新设计为 `attrPetAtkUp` 类型，在 `applyFinalDamage` 和 `enterPetAtkShow` 中当宠物/消除属性为金时，伤害额外乘以 30% 加成

#### 9. `reduceDmg`→`reduceSkillDmg`（w15 寒冰宝鉴）— 受到敌方直接技能伤害-25% ✅ 已重设计
- **问题**：原技能"受到伤害-25%"范围过广
- **修复**：重新设计为 `reduceSkillDmg` 类型，仅对敌方 `aoe` 类型直接技能伤害生效（不含 dot 持续伤害），在 `applyEnemySkill` 中减伤

#### 10. `reduceDmg` 数值调整（w16 厚土宝甲）— 受到所有伤害-15% ✅ 已调整
- **问题**：原减伤28%数值过高
- **修复**：调整为15%，描述改为"受到所有伤害-15%"

#### 11. `reduceDmg`→`reduceAttrAtkDmg`（w14 藤甲天衣）— 受到土属性怪普攻伤害-30% ✅ 已重设计
- **问题**：原技能"受到伤害-18%"范围过广且无特色
- **修复**：重新设计为 `reduceAttrAtkDmg` 类型，仅对土属性怪物的普攻伤害生效，在 `enemyTurn` 中检查敌人属性匹配时额外减伤30%

#### 12. `ignoreDefPct`→`reduceAttrAtkDmg`（w17 烈焰神甲）— 受到金属性怪普攻伤害-30% ✅ 已重设计
- **问题**：原技能"火属性伤害无视15%防御"调整为防御类
- **修复**：重新设计为 `reduceAttrAtkDmg` 类型，仅对金属性怪物的普攻伤害生效，复用 w14 同类型机制

#### 13. `hpMaxUp`→`ignoreDefPct`（w25 磐石仙鼎）— 土属性伤害无视怪物防御 ✅ 已重设计
- **问题**：原技能"血量上限+30%"与 w24 重复
- **修复**：重新设计为 `ignoreDefPct` 类型，pct:100 表示完全无视防御，在 `applyFinalDamage` 中土属性伤害直接跳过防御减免

#### 14. `immuneCtrl`→`breakDef`（w46 镇妖宝塔）— 破防：怪物防御值变为0 ✅ 已重设计
- **问题**：原技能"免疫所有控制"与 w44（免疫眩晕）几乎无区分度，且被 w47（免疫所有负面效果）完全覆盖
- **修复**：重新设计为 `breakDef` 类型，在 `enterBattle` 中直接将怪物防御值置为0

#### 15. `comboDmgUp`→`weakenEnemy`（w8 流云仙扇）— 降低敌方攻击力15% ✅ 已重设计
- **问题**：原技能"Combo伤害+20%"与 w7（Combo伤害+25%）重复且数值更低
- **修复**：重新设计为 `weakenEnemy` 类型，在 `enterBattle` 中降低敌人攻击力15%

#### 16. `comboDmgUp`→`attrPetAtkUp`（w9 燎原宝塔）— 火属性宠物攻击力+30% ✅ 已重设计
- **问题**：原技能"Combo伤害+30%"与 w7（Combo伤害+25%）重复
- **修复**：重新设计为 `attrPetAtkUp` 类型，与 w13 同类型但对应火属性

#### 17. 清理死代码：`immuneCtrl` 法宝检查 ✅ 已清理
- **问题**：w46 已从 `immuneCtrl` 改为 `breakDef`，`applyEnemySkill` 中 stun 分支的 `g.weapon.type === 'immuneCtrl'` 永远不匹配
- **修复**：移除该死代码条件
